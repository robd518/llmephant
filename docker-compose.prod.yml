# ---------- Prod version of docker-compose file ----------
services:
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    ports:
      - "100.97.183.107:3000:8080"
      - "127.0.0.1:3000:8080"
    networks:
      - dev_lab
    restart: unless-stopped
    volumes:
      - llmephant_openwebui:/app/backend/data
    environment:
      DEFAULT_USER_ROLE: ${DEFAULT_USER_ROLE}
      DEVICE_TYPE: ${DEVICE_TYPE}
      DOCKER: ${DOCKER}
      ENABLE_ADMIN_CHAT_ACCESS: ${ENABLE_ADMIN_CHAT_ACCESS}
      ENABLE_FORWARD_USER_INFO_HEADERS: ${ENABLE_FORWARD_USER_INFO_HEADERS}
      ENABLE_LOGIN_FORM: ${ENABLE_LOGIN_FORM}
      ENABLE_PASSWORD_AUTH: ${ENABLE_PASSWORD_AUTH}
      ENABLE_SIGNUP: ${ENABLE_SIGNUP}
      WEBUI_URL: ${WEBUI_URL}
      ENABLE_OAUTH_SIGNUP: ${ENABLE_OAUTH_SIGNUP}
      ENABLE_OAUTH_ID_TOKEN_COOKIE: ${ENABLE_OAUTH_ID_TOKEN_COOKIE}
      ENABLE_OAUTH_PERSISTENT_CONFIG: ${ENABLE_OAUTH_PERSISTENT_CONFIG}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      OAUTH_CLIENT_INFO_ENCRYPTION_KEY: ${OAUTH_CLIENT_INFO_ENCRYPTION_KEY}
      OAUTH_MERGE_ACCOUNTS_BY_EMAIL: ${OAUTH_MERGE_ACCOUNTS_BY_EMAIL}
      OAUTH_PICTURE_CLAIM: ${OAUTH_PICTURE_CLAIM}
      OAUTH_SESSION_TOKEN_ENCRYPTION_KEY: ${OAUTH_SESSION_TOKEN_ENCRYPTION_KEY}
      OAUTH_UPDATE_PICTURE_ON_LOGIN: ${OAUTH_UPDATE_PICTURE_ON_LOGIN}
      OPENID_PROVIDER_URL: ${OPENID_PROVIDER_URL}
      WEBUI_SECRET_KEY: ${WEBUI_SECRET_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openwebui.rule=Host(`llmephant.trashcollector.dev`)"
      - "traefik.http.routers.openwebui.entrypoints=https"
      - "traefik.http.routers.openwebui.tls.certresolver=letsencrypt"

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    ports:
      - "100.97.183.107:6333:6333"
      - "127.0.0.1:6333:6333"
    networks:
      - dev_lab
    volumes:
      - llmephant_qdrant:/qdrant/storage

  memory-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    pull_policy: build
    ports:
      - "100.97.183.107:3001:8080"
      - "127.0.0.1:3001:8080"
    networks:
      - dev_lab
    restart: unless-stopped
    depends_on:
      - qdrant
    command: [ "uvicorn", "llmephant.app:app", "--host", "0.0.0.0", "--port", "8080" ]
    volumes:
      - ./src:/app/src
      - ${TOOLING_CONFIG_FILE}:/app/tooling_config.yml:ro
    environment:
      API_HOST: ${API_HOST}
      API_PORT: ${API_PORT}
      API_HOT_RELOAD: ${API_HOT_RELOAD}
      UPSTREAM_OPENAI_BASE: ${UPSTREAM_OPENAI_BASE}
      UPSTREAM_OPENAI_API_KEY: ${UPSTREAM_OPENAI_API_KEY}
      QDRANT_URL: ${QDRANT_URL}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION}
      EMBEDDING_MODEL_NAME: ${EMBEDDING_MODEL_NAME}
      MCP_BEARER_TOKEN: ${MCP_BEARER_TOKEN}
      MEMORY_MODEL_NAME: ${MEMORY_MODEL_NAME}
      MEMORY_MIN_CONFIDENCE: ${MEMORY_MIN_CONFIDENCE}
      MEMORY_DEDUPE_THRESHOLD: ${MEMORY_DEDUPE_THRESHOLD}
      MEMORY_SIMILARITY_THRESHOLD: ${MEMORY_SIMILARITY_THRESHOLD}
      MEMORY_TTL_DAYS: ${MEMORY_TTL_DAYS}
      ENABLE_MEMORY_EXTRACTION: ${ENABLE_MEMORY_EXTRACTION}
      MEMORY_EXTRACT_MAX_TOKENS: ${MEMORY_EXTRACT_MAX_TOKENS}
      MEMORY_DISTILL_MAX_TOKENS: ${MEMORY_DISTILL_MAX_TOKENS}
      MEMORY_VERIFY_MAX_TOKENS: ${MEMORY_VERIFY_MAX_TOKENS}
      MEMORY_REASONING_EFFORT: ${MEMORY_REASONING_EFFORT}
      DEFAULT_USER_ID: ${DEFAULT_USER_ID}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.memory-api.rule=Host(`llmephant-api.trashcollector.dev`)"
      - "traefik.http.routers.memory-api.entrypoints=https"
      - "traefik.http.routers.memory-api.tls.certresolver=letsencrypt"

networks:
  dev_lab:
    external: true

volumes:
  llmephant_qdrant:
    external: true
  llmephant_openwebui:
    external: true
